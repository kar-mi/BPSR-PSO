name: Build and Release

on:
    push:
        tags:
            - 'v*' # Triggers on version tags like v1.0.0, v2.0.1, etc.

jobs:
    build:
        runs-on: windows-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Build application
              run: npm run build

            - name: Get version from package.json
              id: package-version
              shell: pwsh
              run: |
                  $version = (Get-Content package.json | ConvertFrom-Json).version
                  echo "VERSION=$version" >> $env:GITHUB_OUTPUT

            - name: Find ZIP file
              id: find-zip
              shell: pwsh
              run: |
                  $zipFile = Get-ChildItem -Path "dist/*.zip" | Select-Object -First 1
                  echo "ZIP_PATH=$($zipFile.FullName)" >> $env:GITHUB_OUTPUT
                  echo "ZIP_NAME=$($zipFile.Name)" >> $env:GITHUB_OUTPUT

            - name: Generate Release Notes
              id: generate_notes
              uses: actions/github-script@v7
              with:
                  script: |
                      const { data: release } = await github.rest.repos.generateReleaseNotes({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        tag_name: context.ref.replace('refs/tags/', '')
                      });

                      const installationGuide = `## Installation
                      1. Download the ZIP file below
                      2. Extract to any folder
                      3. Run \`BPSR PSO.exe\`

                      ## Requirements
                      - Windows 10/11 (x64)
                      - Npcap driver (will prompt for installation if not found)
                      - Download Npcap: https://npcap.com/#download

                      ---

                      `;

                      const fullBody = installationGuide + release.body;
                      core.setOutput('release_notes', fullBody);
                      return fullBody;

            - name: Create Release
              id: create_release
              uses: softprops/action-gh-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ github.ref_name }}
                  name: BPSR PSO ${{ github.ref_name }}
                  body: ${{ steps.generate_notes.outputs.release_notes }}
                  draft: false
                  prerelease: false
                  files: ${{ steps.find-zip.outputs.ZIP_PATH }}
                  generate_release_notes: false
